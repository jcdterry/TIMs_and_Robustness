---
title: "Code"
date:  '`r format(Sys.time(), "%d %B, %Y")`'
author: "Chris Terry"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Introduction

This is a tidied version of the code used to generate the results in Terry et al (2019) *Interaction modifications lead to greater robustness than pairwise   non-trophic effects in food webs*

Be warned some analyses take a significant time to run! The results are pre-saved for futher analysis. 


```{r, message=FALSE, warning=FALSE}
library(deSolve)
library(igraph)
library(numDeriv)
library(rootSolve)
library(NetIndices)
library(pbapply)
library(knitr)
library(cowplot)
library(mvbutils)
library(Rcpp)
library(pracma)
library(parallel)
library(R.utils)
library(tidyverse)
```

```{r, message=FALSE, warning=FALSE}
try(sapply(paste0('Scripts/',list.files('Scripts')), source)->tmp)

ParallelRun <- function(DATA,FUNC,Name, ...){
  c1<- makeCluster(3)
  clusterEvalQ(c1,
               {require(dplyr);require(rootSolve);
                 require(deSolve);require(igraph);require(purrr)})->tmp
  clusterExport(c1,as.list(find.funs()[find.funs()!='LV']))
  pblapply(X =DATA, cl = c1,FUN = FUNC,...)-> tmp
  assign(value = tmp,Name)
  save(list=Name,file=paste0('Output from Simulations/',Name))
  stopCluster(c1) 
}

Unpacker <- function(SafeObject){
  SafeObject  %>%transpose %>% `[[`('result') %>% compact() -> x
  return(x)
}

ErrorFinder<- function(SafeObject){
  SafeObject  %>%transpose %>% `[[`('error') -> errormessages
  errormessages %>% map_lgl(is.null) %>% `!` %>% which %>% print
  errormessages %>% compact() %>% print()
}
```

# Methods

## Generating Baseline Communities


```{r, eval=FALSE}

ParallelRun(1:500, CreateModel, 'BaseCommunities',S=35,C=0.14,smallestsize=18)

load('Output from Simulations/BaseCommunities')

BaseCommunities%>% map_lgl('Success') -> Successes
mean(Successes)
BaseCommunities_Success<-BaseCommunities[Successes]

save(BaseCommunities_Success,file='Output from Simulations/BaseCommunities_Success')
```

## Extinctions Without Any TIMs

```{r}
load('Output from Simulations/BaseCommunities_Success')
```

### Build Models
```{r eval=TRUE}
dir.create('No_TIM')

ParallelRun(BaseCommunities_Success,
            AddTIMsMort, 'NoTIM_Models',
            TIM_Density = 0, 
            TIM_Inflexion = 1, TIM_Range = 2, ## Arbitary values,as unused! 
            TIM_Slopes = 1, 
            LimitTIMsPerInteraction =FALSE ,
            FolderName = 'No_TIM')
```

## Test 1 - Comparison of TIM vs Pairwise

### Make the models:
```{r, eval=TRUE}
dir.create('TIMmods')

ParallelRun(BaseCommunities_Success,
            AddTIMsMort,
            'TIMModels',
            TIM_Density = 0.05,
            TIM_Inflexion = 1, 
            TIM_Range = 4,
            TIM_Slopes = 4,
            LimitTIMsPerInteraction = TRUE, 
            FolderName = 'TIMmods')

dir.create('NTEmods')

ParallelRun(BaseCommunities_Success, 
            AddNTEsMort,
            'NTEModels',
            TIM_Density = 0.05,
            TIM_Inflexion = 1, 
            TIM_Range = 4,
            TIM_Slopes = 4)
```

### Run the models:
```{r, eval=TRUE}
load('Output from Simulations/TIMModels')

ParallelRun(TIMModelsInflex,
            safely(EffectofMortality),
            'ExtinctionTIM' , 
            AddedMortality = 1)

load('Output from Simulations/NTEModels')

ParallelRun(NTEModelsInflex,
            safely(EffectofMortality),
            'ExtinctionNTE' ,
            AddedMortality=1)
```

## Test 2 - Relationship Between TIMs and Extinctions
Here just detailing one set of parameters. Orevious ran with other TIM densities, slopes and ranges. 

### Build Models
```{r, eval=TRUE}
ParallelRun(BaseCommunities_Success[1:200],
            AddTIMsMort, 
            'TIM_Models_Lots_Strong',
            TIM_Density = 0.08, 
            TIM_Inflexion = 1, TIM_Range = 3, TIM_Slopes = 3,
            LimitTIMsPerInteraction =FALSE, 
            FolderName = 'TIM_test/LS_TIM'  )
```

### Run Models

```{r eval=TRUE}
load('Output from Simulations/TIM_Models_Lots_Strong')
ParallelRun(TIM_Models_Lots_Strong,
            safely(RunMortality),
            'LS_TIM_Extinctions' , 
            AddedMortality = 1)
```

# Results 

## Number of Extinctions TIMs vs Pairwise

```{r}
load('Output from Simulations/No_TIM_Extinctions')
load('Output from Simulations/ExtinctionTIM_M1Inflex')
load('Output from Simulations/ExtinctionNTE_M1Inflex')

ExtinctionTIM_M1Inflex %>%
  Unpacker  %>%
  bind_rows()  %>%
  mutate(Type = 'TIMs')%>%
  filter(ModelID <467)-> TIMs

ExtinctionNTE_M1Inflex %>% 
  Unpacker%>%
  bind_rows()  %>%
  mutate(Type = 'NTEs')%>%
  filter(ModelID <467) -> NTEs

No_TIM_Extinctions %>%
  Unpacker%>%
  map_df(NumExtinctCalc)  %>%
  mutate(Type = 'NoTIMs') -> NoTIMs

TIM_NTE_comp<-bind_rows(NoTIMs, TIMs, NTEs)

## Success rates
BaseCommunities_Success[1:200] %>%
  map_dbl('StartingNum')%>%
  sum # 3983 starting

TIM_NTE_comp %>% 
  filter(Finished) %>%
  group_by(Type)%>% 
  count() %>%
  mutate(Percent = n / 39.83 )

TIM_NTE_comp %>%
  ggplot(aes(y= Extinctions, x= Type))+
  geom_boxplot(outlier.alpha = 0.1)+
  scale_x_discrete(labels=c('No TIMs', 'Pairwise\nModel', 'Full TIM\nModel'))+
  labs(x='')
ggsave('Figures/Figure4.png', width=5, height=5, dpi = 400)
ggsave('Figures/Figure4.pdf', width=5, height=5, dpi = 400)


TIM_NTE_comp %>%
  group_by(Type)%>%
  summarise(MeanExt=mean(Extinctions, na.rm=TRUE) ,
            MeanFuncExt=mean(NumFuncExtinction, na.rm=TRUE) ,
            MeanExp=mean(NumPopExplosion, na.rm=TRUE),
            SDExt=sd(Extinctions, na.rm=TRUE) ,
            SDFuncExt=sd(NumFuncExtinction, na.rm=TRUE) ,
            SDExp=sd(NumPopExplosion, na.rm=TRUE),
            TotExp=sum(NumPopExplosion, na.rm=TRUE)) %>%
  kable(digits = 3)

t.test(TIM_NTE_comp$Extinctions[TIM_NTE_comp$Type=='NTEs_Inflex'],
       TIM_NTE_comp$Extinctions[TIM_NTE_comp$Type=='TIMs_Inflex'], paired=TRUE)

```

## Distribution of Extinctions

### Trophic Distances from targtted to extinct species 

First get data into shape:
```{r}

load('Output from Simulations/No_TIM_Extinctions')
load('Output from Simulations/LS_TIM_Extinctions')

```

```{r}

TrophDistCalc<- function(Model){
  Model$web %>%
    graph_from_adjacency_matrix() %>%
    distances(mode = 'all') -> TrophicDistancesMatrix
  diag(TrophicDistancesMatrix)<-NA
  return(data.frame('TrophDistList'=as.vector(TrophicDistancesMatrix)))
}

BaseCommunities_Success %>%
  map(CutModelDown)%>%
  map_df(TrophDistCalc) %>%
  filter(!is.na(TrophDistList))%>%
  filter(TrophDistList <5)%>%
  mutate(TIMType = 'Baseline')-> AllTrophDist

LS_TIM_Extinctions  %>%
  Unpacker%>% 
  map_df(TrophDistTIMs) %>%
  mutate(TIMType='TIMs (LS) Extinctions') %>%
  filter(!is.na(TrophDistList))%>%
  filter(TrophDistList <5)-> LS_Results_TrophDist

No_TIM_Extinctions  %>%Unpacker%>% 
  map_df(TrophDistTIMs) %>%
  filter(!is.na(TrophDistList))%>%
  filter(TrophDistList <5)%>%
  mutate(TIMType='No TIMs Extinctions') -> No_Results_TrophDist

bind_rows(AllTrophDist, 
          LS_Results_TrophDist, 
          No_Results_TrophDist) %>%
  group_by(TIMType)%>%
  summarise('Mean Trophic Distance' = mean(TrophDistList, na.rm=TRUE))%>%
  kable(digits = 2)

nrow(AllTrophDist)
nrow(LS_Results_TrophDist)
nrow(No_Results_TrophDist)

set.seed(1)
bind_rows(sample_n(AllTrophDist, 3583), 
          sample_n(LS_Results_TrophDist, 3583), 
          sample_n(No_Results_TrophDist, 3583)) %>%
  group_by(TIMType)%>%
  count(TrophDistList) %>%
  mutate(n= n/3583)%>%
  ggplot(aes(x=factor(TrophDistList), y=n,fill = TIMType )) +
  geom_bar(stat = 'identity', position = 'dodge')+
  labs(x= 'Trophic Distance',
       y= 'Proportion')+
  scale_x_discrete(breaks= 1:4,labels=c(1,2,3,4))+
  scale_fill_grey(name= '',
                  labels=c('Baseline - All species',
                           'No TIMs case - Targeted-Extinct',
                           'TIMs - Targeted-Extinct'))+
  theme(legend.position=c(0.55,0.9), legend.text = element_text(size=10))+
  guides(y=FALSE)

ggsave('Figures/Figure5.png', width = 6, height=4)
ggsave('Figures/Figure5.pdf', width = 6, height=4)

```


## TIM frequency and vulnerabilty distribution

```{r, eval=TRUE}
LS_TIM_Extinctions  %>%Unpacker%>%
  map_df(CalcExpTIMs, TIM_Density=0.08) -> LS_Results3
LS_Results3 %>% mutate(TIMType='LS') ->LS_Results3

save(LS_Results3, file = 'Output from Simulations/LS_Results3')

```

```{r}
load('Output from Simulations/LS_Results3')

LS_Results3%>%
  summarise('Mean B From All'=mean(mean_BenefTIMsfromAnytoEx_list),
            'Mean D From All'=mean(mean_DetriTIMsfromAnytoEx_list),
            'Expected From All'=mean(AllExpNum),
            'Mean B From H'=mean(mean_BenefTIMsfromHtoEx_list),
            'Mean D From H'=mean(mean_DetriTIMsfromHtoEx_list),
            'Expected From H'=mean(HuntedExpNum))%>%
  kable(digits = 3)

LS_Results3%>%
  summarise('SD B From All'=sd(mean_BenefTIMsfromAnytoEx_list),
            'SD D From All'=sd(mean_DetriTIMsfromAnytoEx_list),
            'SD Expected From All'=sd(AllExpNum),
            'SD B From H'=sd(mean_BenefTIMsfromHtoEx_list),
            'SD D From H'=sd(mean_DetriTIMsfromHtoEx_list),
            'SD Expected From H'=sd(HuntedExpNum))%>%
  kable(digits = 3)

## ANOVA Tests
LS_Results3%>% 
  gather('Type','Number' ,
         mean_BenefTIMsfromAnytoEx_list,
         mean_DetriTIMsfromAnytoEx_list,
         AllExpNum) %>%
  lm(Number~ Type, data=.)%>%  anova

LS_Results3%>% 
  gather('Type','Number' ,mean_BenefTIMsfromHtoEx_list,
         mean_DetriTIMsfromHtoEx_list, HuntedExpNum) %>%
  lm(Number~ Type, data=.)%>%  anova


## Pairwise paired t-tests (with welch variance correction) (all incredibly significant)

t.test(x = LS_Results3$mean_BenefTIMsfromAnytoEx_list,
       y=LS_Results3$AllExpNum, paired=TRUE)
t.test(x = LS_Results3$mean_DetriTIMsfromAnytoEx_list,
       y=LS_Results3$AllExpNum, paired=TRUE)

t.test(x = LS_Results3$mean_BenefTIMsfromHtoEx_list,
       y=LS_Results3$HuntedExpNum, paired=TRUE)
t.test(x = LS_Results3$mean_DetriTIMsfromHtoEx_list,
       y=LS_Results3$HuntedExpNum, paired=TRUE)
       
       
```

# ```{r}
# No_TIM_Extinctions  %>%Unpacker%>%
#   map_df(AnalyseEffectOfMortality)%>%
#   mutate(TIMType='None') -> No_Results
# LS_TIM_Extinctions  %>%Unpacker%>%
#   map_df(AnalyseEffectOfMortality)%>%
#   mutate(TIMType='LS') -> LS_Results
# 
# TIMResults<-bind_rows(No_Results,LS_Results)
# save(TIMResults, file = 'Output from Simulations/TIMResults')
# ```
# 
# ```{r}
# load('Output from Simulations/TIMResults')
# ```


## 4 TIMs from Hunted

```{r}
TIMResults %>%
  gather('TIMClassFromHunted', 'Count',
         NumPosTIMsFromHunted, NumNegTIMsFromHunted) %>%
  filter(Count<6 & TIMType=='LS')%>%
  ggplot(aes(x=factor(Count),y=Extinctions,
           #  col=TIMClassFromHunted, 
             fill=TIMClassFromHunted))+
  geom_boxplot()+
  scale_fill_manual(name= 'TIM Sign',
                     labels=c('Interfering','Facilitating'),
                     values = c('lightgrey', 'darkgrey') )+
  labs(x='Number of TIMs from targeted\nspecies with specified sign', y='') -> Split

TIMResults %>%
  filter(NumTIMsFromHunted<12 & TIMType=='LS')%>%
  ggplot(aes(x=factor(NumTIMsFromHunted),y=Extinctions))+
  geom_boxplot()+
  labs(x='Total number of TIMs from\ntargeted species')-> All


plot_grid(All, Split, labels=c('a.', 'b.'))
ggsave('Figures/Figure6.png',dpi = 400, width = 8, height=4)

TIMResults %>%
  gather('TIMClassFromHunted', 'Count',
         NumPosTIMsFromHunted, NumNegTIMsFromHunted) %>%
  filter(Count<6 & TIMType=='LS')%>%
  glm(Extinctions ~ Count, data=., family='poisson') %>%
  summary


TIMResults %>%
  filter(NumTIMsFromHunted<12 & TIMType=='LS')%>%
  glm(Extinctions ~ NumTIMsFromHunted + TrophConn, data=., family='poisson') %>%
  summary

TIMResults %>%
  filter(NumTIMsFromHunted<12 & TIMType=='LS')%>%
  glm(Extinctions ~ NumTIMsFromHunted, data=., family='poisson') -> TotTIMsGLM

TotTIMsGLM%>%
  summary

TIMResults %>%
  filter(NumTIMsFromHunted<12 & TIMType=='LS')%>%
  glm(Extinctions ~ NumPosTIMsFromHunted+NumNegTIMsFromHunted,
      data=., family='poisson') ->SplitGLM

summary(SplitGLM)

TIMResults %>%
  filter(NumTIMsFromHunted<12 & TIMType=='LS')%>%
  glm(Extinctions ~ NumPosTIMsFromHunted+NumNegTIMsFromHunted+ TrophConn, 
      data=., family='poisson') -> SplitTrophGLM

summary(SplitTrophGLM)

anova(SplitGLM, TotTIMsGLM,test="Chisq")
anova(SplitGLM, SplitTrophGLM,test="Chisq")

TIMResults %>%
  filter(TIMType=='LS')%>%
  ggplot(aes(NumPosTIMsFromHunted,NumNegTIMsFromHunted))+
  geom_point() + geom_smooth(method = 'lm')

```


# SI 

## SI 1. Body mass distribution

```{r}
load('Output from Simulations/BaseCommunities_Success')

BaseCommunities_Success<-BaseCommunities_Success[1:200]

BaseCommunities_Success%>%
  map(CutModelDown)%>%
  map('web') %>%
  map(GetTL) %>% unlist-> NewTLs

BaseCommunities_Success %>%
  map(CutModelDown) -> CutDown

map_dbl(CutDown,'StartingNum')-> Sp
map(CutDown,'TL')%>% unlist-> TL
map(CutDown,'StartPoints')%>% unlist-> Eqm
map(CutDown,'K')%>% unlist-> K

## Body Size / TL
map(BaseCommunities_Success,function(Model){
return(Model$BMs[which(Model$Start>0)])
})%>% unlist-> BM

data.frame(BM, TL)%>%
  filter(TL>1,TL < 5)%>%
  ggplot(aes(col=factor(TL), fill= factor(TL), x=BM))+
  geom_density(alpha=0.5)+
  scale_x_log10()+
  geom_vline(xintercept =1, size=2 )+
 scale_color_discrete(name='Trophic Level')+
   scale_fill_discrete(name='Trophic Level')+
  labs(x='Body-mass', y='')

ggsave('Figures/Distribution of Body Masses.png', width = 6, height=4, dpi = 400)

```

### SI 2. Details of starting populations

```{r}
data.frame('NumberSp'=Sp)%>%
  ggplot(aes(x=Sp))+
  geom_bar()+
  scale_x_continuous(breaks=18:27, labels=18:27)+
  labs(x= 'Starting Community Size', y= 'Count') -> A

data.frame(NewTLs)%>%
  ggplot(aes(x=NewTLs))+
  geom_histogram(bins=20)+
  scale_x_continuous(breaks=c(1,2,2.5,3,3.5,4),
                     labels=c(1,2,2.5,3,3.5,4),
                     limits = c(0.9,4.1))+
  labs( x='Trophic Level Of Species', y='Number of Species') -> B
tail(sort(NewTLs),10)

data.frame(NewTLs, Eqm)%>%
  filter(Eqm > 0.01)%>%
  ggplot(aes(x=NewTLs, y=Eqm))+
  geom_point(alpha=0.1)+
  scale_y_log10(breaks=c(0.001, 0.01, 0.1, 1, 10, 100) ,
                labels=c(0.001, 0.01, 0.1, 1, 10, 100 ))+
  labs(y='Starting Equilibrium Biomass', x='Trophic Level Of Species') -> C


data.frame('C' =Eqm/K,  TL)%>%
  mutate(TLCat = ifelse(TL==1,'Producer', 'Consumer'  ))%>%
  ggplot(aes(x=C))+
  geom_histogram()+
  facet_wrap(~TLCat)+
  scale_x_continuous(breaks=c(0,0.25, 0.5, 0.75,1),
                     labels=c(0,0.25, 0.5, 0.75,1))+
  labs(x='Equilibrium Fraction of K', 
       y='Number of Species') -> D

plot_grid(A,B,C,D, labels = 'AUTO')
    
ggsave('Figures/CommunityInfoPlots.png', width = 8, height=8, dpi = 400)

```


## SI 5 Initial direction of response


```{r eval=TRUE}
TIM_Models_Lots_Strong[[1]] -> Model

load('Output from Simulations/TIM_Models_Lots_Strong')

TIM_Models_Lots_Strong %>%
  map(TestInitialResponse) -> AllDirectionResponses

AllDirectionResponses%>% 
  unlist %>%
  table -> Dir_Table

Dir_Table[3]/(Dir_Table[1]+Dir_Table[3]) *100

Dir_Table / sum(Dir_Table)
```

SI XFrequency of predator release motif



### Motifs of Extinctions

```{r}


LS_TIM_unpacked<- Unpacker(LS_TIM_Extinctions)



### What is the total number of species that:
## have a consumer 
## have their threat reduced by a modifier
## the modifier was targetted


#run<- LS_TIM_unpacked[[12]]


MotifFreq<-function(run){
  
  
  Complete<- run$postExtEnd_List %>% map_lgl( function(x) {all(x!='DNF')})
  
  run$postExtEnd_List[Complete]%>%
    unlist%>%
    matrix(nrow = sum(Complete), byrow=TRUE)-> Results
  
  MotifFrequency <- data.frame('MotifFrequency' = rep(0,run$S ),
                               'n_Extinctions' = 0,
                               'OverallExtinctionFreq' = NA)
  
  for(ii in 1:sum(Complete)){
    
    target <- which(Complete)[ii]
    
    run$TIMlist%>%
      filter(i %in% which(rowSums(run$web)>1),
             k== target, 
             slope_ijk <0)%>%
      select(i)%>%
      unlist -> SuppressedResources
    
    MotifFrequency$OverallExtinctionFreq[target] <- mean(Results[ii,]==0)
    
    if(length(SuppressedResources>0)){
      MotifFrequency$MotifFrequency[target] <- length(SuppressedResources)
      MotifFrequency$n_Extinctions[target] <-  sum(Results[ii,SuppressedResources] ==0)
    }else{
      MotifFrequency$MotifFrequency[target] <-0
      MotifFrequency$n_Extinctions[target] <- 0
    }
  }
  return(MotifFrequency)
}

LS_TIM_unpacked %>%
  map_df(MotifFreq)-> OverallMotifFreqResults


OverallMotifFreqResults %>%
  mutate(MotifExtFreq = n_Extinctions /MotifFrequency )%>%
  filter(!is.na(OverallExtinctionFreq))%>%
  mutate(MotifExtFreq = ifelse(is.nan(MotifExtFreq),0,MotifExtFreq) )%>%
  colMeans()


```

# Session Info

```{r}

sessionInfo()
```
