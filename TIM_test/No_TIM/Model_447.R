

  ModelIIPars <- list(Aij= matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.1102,0.1102,0.1102,0.1102,0.1102,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01716,0.01716,0.01716,0.01716,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01141,0.01141,0.01141,0.01141,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01411,0.01411,0.01411,0.01411,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.007053,0.007053,0.007053,0.007053,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01511,0.01511,0.01511,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.003071,0.003071,0.003071,0.003071,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.02519,0.02519,0.02519,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0104,0.0104,0.0104,0.0104,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01303,0.01303,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01127,0.01127,0.01127,0.01127,0.01127,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0.0009753,0,0,0,0,0,0,0,0,0,0.002475,0.002475,0.002475,0.002475,0.002475,0.002475,0.002475,0.002475,0.002475,0.002475,0,0,0,0),nrow=21,ncol=21),
                    Es= matrix(c(0.108,0.095,0.11,0.104,0.137,0.114,0.117,0.103,0.086,0.076,0.122,0.071,0.051,0.089,0.092,0.101,0.136,0.1,0.065,0.089,0.136,0.112,0.061,0.073,0.069,0.12,0.117,0.102,0.075,0.062,0.121,0.13,0.055,0.112,0.135,0.062,0.133,0.064,0.136,0.134,0.131,0.074,0.056,0.068,0.072,0.118,0.139,0.148,0.055,0.088,0.099,0.095,0.09,0.067,0.08,0.118,0.142,0.141,0.143,0.147,0.147,0.079,0.141,0.124,0.104,0.076,0.103,0.059,0.14,0.099,0.149,0.052,0.145,0.075,0.087,0.144,0.08,0.105,0.118,0.068,0.14,0.053,0.055,0.082,0.102,0.14,0.118,0.144,0.051,0.094,0.081,0.131,0.126,0.118,0.145,0.084,0.105,0.102,0.142,0.094,0.148,0.085,0.136,0.145,0.061,0.076,0.089,0.134,0.104,0.147,0.122,0.101,0.089,0.117,0.12,0.056,0.077,0.141,0.131,0.06,0.1,0.076,0.072,0.1,0.137,0.052,0.118,0.113,0.111,0.089,0.122,0.109,0.086,0.107,0.117,0.081,0.143,0.112,0.105,0.101,0.055,0.119,0.147,0.125,0.115,0.067,0.14,0.14,0.135,0.142,0.121,0.074,0.101,0.07,0.066,0.064,0.115,0.114,0.137,0.089,0.136,0.051,0.073,0.119,0.111,0.081,0.144,0.077,0.059,0.129,0.063,0.149,0.119,0.132,0.098,0.145,0.087,0.055,0.094,0.09,0.06,0.124,0.148,0.062,0.104,0.075,0.106,0.061,0.106,0.092,0.083,0.106,0.079,0.103,0.073,0.135,0.059,0.103,0.119,0.065,0.081,0.15,0.102,0.119,0.065,0.06,0.142,0.091,0.062,0.086,0.062,0.133,0.073,0.109,0.119,0.121,0.1,0.079,0.068,0.139,0.079,0.071,0.092,0.075,0.125,0.077,0.113,0.071,0.138,0.144,0.085,0.108,0.139,0.12,0.083,0.068,0.134,0.073,0.089,0.083,0.107,0.096,0.108,0.129,0.085,0.08,0.061,0.149,0.09,0.097,0.101,0.085,0.149,0.065,0.106,0.059,0.093,0.103,0.125,0.053,0.086,0.055,0.121,0.127,0.051,0.114,0.071,0.093,0.075,0.117,0.059,0.087,0.056,0.109,0.103,0.124,0.113,0.099,0.149,0.091,0.121,0.104,0.108,0.102,0.086,0.135,0.117,0.144,0.081,0.13,0.08,0.063,0.14,0.054,0.147,0.11,0.115,0.077,0.092,0.078,0.069,0.12,0.054,0.058,0.068,0.126,0.106,0.059,0.06,0.052,0.05,0.087,0.133,0.131,0.111,0.071,0.106,0.108,0.093,0.106,0.06,0.062,0.104,0.053,0.136,0.106,0.143,0.148,0.096,0.144,0.065,0.076,0.088,0.103,0.125,0.147,0.079,0.091,0.093,0.123,0.095,0.099,0.083,0.07,0.086,0.141,0.057,0.066,0.06,0.094,0.099,0.146,0.093,0.084,0.141,0.124,0.058,0.091,0.124,0.068,0.066,0.111,0.063,0.147,0.138,0.148,0.139,0.129,0.068,0.065,0.071,0.146,0.089,0.087,0.143,0.147,0.088,0.063,0.09,0.057,0.103,0.126,0.115,0.094,0.118,0.124,0.094,0.066,0.061,0.094,0.056,0.057,0.092,0.129,0.091,0.084,0.065,0.06,0.104,0.088,0.13,0.129,0.144,0.075,0.089,0.128,0.062,0.139,0.058,0.124,0.109,0.078,0.107,0.102,0.119,0.053,0.076,0.051,0.137,0.145,0.085,0.103,0.08,0.053,0.092,0.074,0.068,0.126,0.058,0.051,0.106,0.063,0.054,0.131,0.064,0.073,0.129,0.123,0.147,0.097,0.098),nrow=21,ncol=21),
                    r = c(1,1,1,1,1,1,1,-0.08816,-0.01373,-0.01141,-0.01129,-0.004932,-0.01209,-0.002766,-0.01762,-0.01144,-0.002606,1,-0.0124,-0.001659,-0.003711),
                    K = c(12.51,11.04,15.04,10.02,12.4,8.082,10.19,291.7,214.3,498.3,756.2,773.2,118.9,563.3,417,100.2,128.8,7.215,921.1,449.9,879.4))
  
  LVModel <- function(t, Bs, pars=NULL){
   TIMlist<- pars$TIMs
   ## ID = 447 
   
   if(any(is.nan(Bs))){Bs[is.nan(Bs)]<- 0}
   if(any(Bs<1e-10)){Bs[Bs<1e-10]<- 0}

   LogRatioVect   <-  log10( Bs[TIMlist$k] / TIMlist$Start) 
   LogRatioVect[LogRatioVect< -3]<- -3  # Put a floor on change

   LogmuVect = TIMlist$Flip * (TIMlist$Range_ijk *  exp(-(TIMlist$gomp_b) * exp(- (TIMlist$gomp_c)* LogRatioVect  )) - TIMlist$gomp_f0)
   LogmuVect[is.na(LogmuVect)]<-0
   Logmu_ijk<- array(0, c(21,21,21))
   Logmu_ijk[ as.matrix(TIMlist[,1:3])  ] <- LogmuVect
   mu_ij<- 10^(rowSums(Logmu_ijk, dims = 2))

   Amodij <- mu_ij*pars$Aij

   Yij <-  t(Amodij)*Bs  # losses rate per loser
   Zij <-  pars$Es*Amodij*Bs # gain rate per gainer
             
   dBs<- Bs* ( pars$r - pars$Mort  -(Bs/pars$K)   -colSums(Yij)+   colSums(Zij))
             
   dBs[is.nan(Bs)]<-0
   dBs[Bs<1e-10]<-0
   
   return(list(as.vector(dBs)))
  }
             