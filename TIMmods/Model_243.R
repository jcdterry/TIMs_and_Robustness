

  ModelIIPars <- list(Aij= matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.1074,0.1074,0.1074,0.1074,0.1074,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.1146,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.1117,0.1117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.007848,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.62,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.005553,0.005553,0.005553,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.006695,0.006695,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.004983,0.004983,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.002616,0.002616,0.002616,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0.001812,0,0,0,0,0,0,0,0,0,0,0,0,0.001751,0.001751,0.001751,0.001751,0.001751,0.001751,0.001751,0.001751,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.01372,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.005537,0.005537,0.005537,0.005537,0.005537,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.004723,0.004723,0.004723,0,0,0,0,0,0,0,0,0,0,0,0,0.02539,0.02539,0.02539,0.02539,0.02539,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),nrow=23,ncol=23),
                    Es= matrix(c(0.1,0.075,0.136,0.057,0.15,0.062,0.094,0.115,0.058,0.144,0.091,0.07,0.124,0.118,0.065,0.135,0.137,0.143,0.133,0.136,0.11,0.112,0.077,0.105,0.055,0.087,0.141,0.062,0.097,0.113,0.059,0.111,0.098,0.086,0.077,0.11,0.084,0.073,0.059,0.087,0.115,0.068,0.097,0.066,0.127,0.082,0.074,0.122,0.131,0.073,0.101,0.128,0.139,0.124,0.061,0.128,0.093,0.124,0.085,0.062,0.083,0.063,0.092,0.11,0.134,0.124,0.128,0.128,0.145,0.102,0.103,0.053,0.085,0.111,0.084,0.105,0.069,0.144,0.1,0.132,0.061,0.087,0.094,0.135,0.055,0.071,0.095,0.128,0.11,0.078,0.08,0.058,0.079,0.093,0.123,0.134,0.143,0.112,0.057,0.086,0.09,0.064,0.073,0.086,0.062,0.066,0.136,0.133,0.113,0.054,0.054,0.134,0.139,0.118,0.148,0.129,0.148,0.089,0.097,0.098,0.142,0.09,0.067,0.131,0.072,0.136,0.075,0.059,0.107,0.094,0.135,0.081,0.069,0.1,0.1,0.109,0.095,0.094,0.086,0.079,0.123,0.053,0.077,0.096,0.131,0.058,0.125,0.113,0.068,0.081,0.148,0.138,0.129,0.14,0.073,0.081,0.106,0.113,0.085,0.087,0.081,0.077,0.115,0.129,0.134,0.071,0.073,0.11,0.123,0.106,0.084,0.102,0.128,0.058,0.128,0.061,0.125,0.146,0.099,0.147,0.116,0.123,0.114,0.105,0.111,0.102,0.15,0.131,0.066,0.072,0.102,0.106,0.138,0.128,0.059,0.144,0.091,0.08,0.097,0.13,0.053,0.09,0.101,0.072,0.132,0.104,0.139,0.055,0.089,0.052,0.058,0.077,0.146,0.138,0.081,0.1,0.129,0.068,0.148,0.122,0.091,0.145,0.075,0.128,0.119,0.092,0.1,0.094,0.103,0.147,0.147,0.13,0.13,0.144,0.097,0.122,0.096,0.126,0.065,0.11,0.122,0.065,0.086,0.131,0.108,0.096,0.117,0.121,0.094,0.13,0.124,0.123,0.096,0.127,0.114,0.103,0.121,0.088,0.104,0.112,0.125,0.109,0.101,0.103,0.109,0.081,0.078,0.145,0.072,0.075,0.138,0.106,0.128,0.067,0.14,0.141,0.122,0.06,0.14,0.05,0.056,0.091,0.134,0.088,0.099,0.133,0.103,0.077,0.054,0.139,0.055,0.144,0.052,0.052,0.14,0.096,0.071,0.081,0.116,0.124,0.113,0.051,0.102,0.122,0.076,0.051,0.112,0.063,0.079,0.135,0.058,0.088,0.122,0.142,0.05,0.119,0.062,0.086,0.122,0.146,0.108,0.125,0.098,0.096,0.069,0.114,0.057,0.086,0.14,0.088,0.122,0.074,0.075,0.057,0.084,0.055,0.09,0.12,0.088,0.058,0.128,0.092,0.132,0.071,0.124,0.092,0.059,0.15,0.115,0.122,0.095,0.112,0.051,0.136,0.142,0.106,0.063,0.064,0.077,0.065,0.109,0.147,0.112,0.102,0.113,0.08,0.065,0.074,0.131,0.05,0.107,0.144,0.067,0.148,0.094,0.112,0.072,0.137,0.077,0.058,0.148,0.144,0.127,0.107,0.087,0.072,0.083,0.112,0.121,0.064,0.114,0.105,0.137,0.104,0.099,0.092,0.142,0.113,0.1,0.106,0.063,0.073,0.126,0.142,0.092,0.051,0.147,0.092,0.099,0.083,0.139,0.138,0.097,0.138,0.109,0.055,0.115,0.059,0.1,0.114,0.146,0.067,0.118,0.138,0.132,0.099,0.138,0.05,0.105,0.057,0.063,0.135,0.135,0.092,0.117,0.079,0.076,0.148,0.052,0.094,0.052,0.094,0.081,0.067,0.108,0.101,0.122,0.138,0.092,0.113,0.088,0.092,0.134,0.144,0.073,0.092,0.098,0.107,0.088,0.082,0.084,0.138,0.054,0.075,0.109,0.088,0.074,0.069,0.069,0.103,0.081,0.057,0.133,0.146,0.144,0.147,0.145,0.105,0.058,0.06,0.059,0.106,0.094,0.145,0.059,0.125,0.1,0.124,0.066,0.098,0.083,0.083,0.131,0.136,0.143,0.14,0.135,0.113,0.076,0.142,0.144,0.14,0.127,0.066,0.08,0.103,0.065,0.068,0.096,0.086,0.087,0.056,0.137,0.094,0.086,0.149,0.112,0.118,0.109,0.138,0.073,0.071,0.116,0.08,0.129,0.114,0.092,0.146,0.114),nrow=23,ncol=23),
                    r = c(1,1,1,1,1,-0.0751,1,-0.02291,-0.03355,-0.00157,1,1,-0.062,-0.003883,-0.003348,-0.003485,-0.002093,-0.003624,-0.00315,-0.002743,-0.004429,-0.003303,-0.02031),
                    K = c(19.16,15.71,5.625,6.996,8.016,285.5,13.07,697.6,549.4,172.4,4.695,17.3,352,159.8,417.5,581.1,932.4,183.5,350.2,111.3,522.4,683.2,179.7))
  
  LVModel <- function(t, Bs, pars=NULL){
   TIMlist<- pars$TIMs
   ## ID = 243 
   
   if(any(is.nan(Bs))){Bs[is.nan(Bs)]<- 0}
   if(any(Bs<1e-10)){Bs[Bs<1e-10]<- 0}

   LogRatioVect   <-  log10( Bs[TIMlist$k] / TIMlist$Start) 
   LogRatioVect[LogRatioVect< -10]<- -10  # Put a floor on change to stop infinity issues

   LogmuVect = TIMlist$Flip * (TIMlist$Range_ijk *  exp(-(TIMlist$gomp_b) * exp(- (TIMlist$gomp_c)* LogRatioVect  )) - TIMlist$gomp_f0)
   LogmuVect[is.na(LogmuVect)]<-0
   Logmu_ijk<- array(0, c(23,23,23))
   Logmu_ijk[ as.matrix(TIMlist[,1:3])  ] <- LogmuVect
   mu_ij<- 10^(rowSums(Logmu_ijk, dims = 2))

   Amodij <- mu_ij*pars$Aij

   Yij <-  t(Amodij)*Bs  # losses rate per loser
   Zij <-  pars$Es*Amodij*Bs # gain rate per gainer
             
   dBs<- Bs* ( pars$r - pars$Mort  -(Bs/pars$K)   -colSums(Yij)+   colSums(Zij))
             
   dBs[is.nan(Bs)]<-0
   dBs[Bs<1e-10]<-0
   
   return(list(as.vector(dBs)))
  }
             